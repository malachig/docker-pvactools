#License Agreements
#pVACtools is licensed under [NPOSL-3.0](http://opensource.org/licenses/NPOSL-3.0).

#By using the IEDB software, you are consenting to be bound by and become a "Licensee" for the use of IEDB tools and are consenting to the terms and conditions of the Non-Profit Open Software License ("Non-Profit OSL") version 3.0

#Please read these two license agreements [here](http://tools.iedb.org/mhci/download/) before proceeding. If you do not agree to all of the terms of these two agreements, you must not install or use the product. Companies (for-profit entities) interested in downloading the command-line versions of the IEDB tools or running the entire analysis resource locally, should contact us (license@iedb.org) for details on licensing options.

#Citing the IEDB
#All publications or presentations of data generated by use of the IEDB Resource Analysis tools should include citations to the relevant reference(s), found [here](http://tools.iedb.org/mhci/reference/).


FROM python:3.7
MAINTAINER Susanna Kiwala <ssiebert@wustl.edu>

LABEL \
    description="Image for pVACtools" \
    version="3.0.0_mhci_3.1.2_mhcii_3.1.6"

RUN apt-get update && apt-get install -y \
    tcsh \
    gcc \
    build-essential \
    zlib1g-dev \
    gawk

RUN mkdir /opt/iedb
COPY LICENSE /opt/iedb/.

#IEDB MHC I 3.1.2
WORKDIR /opt/iedb
RUN wget https://downloads.iedb.org/tools/mhci/3.1.2/IEDB_MHC_I-3.1.2.tar.gz
RUN tar -xzvf IEDB_MHC_I-3.1.2.tar.gz
WORKDIR /opt/iedb/mhc_i
RUN ./configure
COPY netmhccons_1_1_python_interface.3.1.1.py /opt/iedb/mhc_i/method/netmhccons-1.1-executable/netmhccons_1_1_executable/netmhccons_1_1_python_interface.py
WORKDIR /opt/iedb
RUN rm IEDB_MHC_I-3.1.2.tar.gz

#IEDB MHC II 3.1.6
WORKDIR /opt/iedb
RUN wget https://downloads.iedb.org/tools/mhcii/3.1.6/IEDB_MHC_II-3.1.6.tar.gz
RUN tar -xzvf IEDB_MHC_II-3.1.6.tar.gz
WORKDIR /opt/iedb/mhc_ii
RUN python ./configure.py
WORKDIR /opt/iedb
RUN rm IEDB_MHC_II-3.1.6.tar.gz

#BLAST
WORKDIR /opt
RUN wget https://ftp.ncbi.nlm.nih.gov/blast/executables/blast+/2.12.0/ncbi-blast-2.12.0+-x64-linux.tar.gz
RUN tar zxvpf ncbi-blast-2.12.0+-x64-linux.tar.gz
RUN rm ncbi-blast-2.12.0+-x64-linux.tar.gz
RUN mkdir /opt/blastdb
ENV BLASTDB=/opt/blastdb
WORKDIR /opt/blastdb
RUN perl /opt/ncbi-blast-2.12.0+/bin/update_blastdb.pl --passive --decompress refseq_select_prot

#pVACtools 3.0.0
RUN mkdir /opt/mhcflurry_data
ENV MHCFLURRY_DATA_DIR=/opt/mhcflurry_data
RUN pip install tensorflow==2.2.2
RUN pip install pvactools==3.0.0
RUN mhcflurry-downloads fetch

#pVACsplice for dev/testing prior to creation of a pip package
RUN pip install pyfaidx
RUN git clone https://github.com/malachig/pVACtools.git
RUN cd pVACtools && git checkout staging
RUN cp pVACtools/tmp/pvacsplice /usr/local/bin
RUN chmod +x /usr/local/bin/pvacsplice
RUN cp -f -R pVACtools/pvactools/* /usr/local/lib/python3.7/site-packages/pvactools/

CMD ["/bin/bash"]
